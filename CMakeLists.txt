cmake_minimum_required(VERSION 3.0)
project(zipfiles)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
set(CMAKE_CXX_STANDARD 17)
# 设置目录
set(ZIPFILES_INCLUDE_DIR ${CMAKE_SOURCE_DIR}/include)
set(ZIPFILES_SOURCE_DIR ${CMAKE_SOURCE_DIR}/src)
set(ZIPFILES_TEST_DIR ${CMAKE_SOURCE_DIR}/tests)
set(ZIPFILES_UNIT_TEST_DIR ${ZIPFILES_TEST_DIR}/unittest)
set(ZIPFILES_BINARY_DIR ${CMAKE_SOURCE_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${ZIPFILES_BINARY_DIR})

set(ZIPFILES_ENTRY ${ZIPFILES_SOURCE_DIR}/main.cpp)
set(ZIPFILES_COMMON_H ${ZIPFILES_INCLUDE_DIR}/common.h)
set(ZIPFILES_UTIL_H ${ZIPFILES_INCLUDE_DIR}/utils.h)
set(ZIPFILES_COPYFILES_H ${ZIPFILES_INCLUDE_DIR}/copyfile.h)
set(ZIPFILES_COPYFILES_CPP ${ZIPFILES_SOURCE_DIR}/copyfile.cpp)
set(ZIPFILES_UTIL_CPP ${ZIPFILES_SOURCE_DIR}/utils.cpp)
set(CMAKE_CXX_FLAGS_MINSIZEREL "-O3 -DNDEBUG")
file(GLOB ZIPFILES_UNIT_TEST_FILES ${ZIPFILES_UNIT_TEST_DIR}/*.cpp)
include_directories(${ZIPFILES_INCLUDE_DIR})
add_executable(
    ZIPFILES
    ${ZIPFILES_COMMON_H}
    ${ZIPFILES_UTIL_H}
    ${ZIPFILES_COPYFILES_H}
    ${ZIPFILES_ENTRY}
    ${ZIPFILES_UTIL_CPP}
    ${ZIPFILES_COPYFILES_CPP}
)
add_custom_target(
    clang-format
    COMMAND clang-format
    -i
    ${ZIPFILES_COMMON_H}
    ${ZIPFILES_UTIL_H}
    ${ZIPFILES_COPYFILES_H}
    ${ZIPFILES_ENTRY}
    ${ZIPFILES_UTIL_CPP}
    ${ZIPFILES_COPYFILES_CPP}
    COMMENT "Running clang-format on source files"
)
add_dependencies(clang-format ZIPFILES )
find_package(GTest REQUIRED)
add_executable(
    ZIPFILES_UNIT_TEST
    ${ZIPFILES_COMMON_H}
    ${ZIPFILES_UTIL_H}
    ${ZIPFILES_COPYFILES_H}
    ${ZIPFILES_UTIL_CPP}
    ${ZIPFILES_COPYFILES_CPP}
    ${ZIPFILES_UNIT_TEST_FILES}
)
add_library(ZIPFILES_SHARED SHARED ${ZIPFILES_UTIL_CPP} ${ZIPFILES_COPYFILES_CPP})
set_target_properties(ZIPFILES_SHARED PROPERTIES OUTPUT_NAME "zipfiles")
target_link_libraries(ZIPFILES_UNIT_TEST GTest::GTest GTest::Main)
enable_testing()
add_test(
    NAME ZIPFILES_UNIT_TEST
    COMMAND ZIPFILES_UNIT_TEST
)

