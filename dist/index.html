<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <title>Log Example</title>
    <script>
        // 等待文档加载完成
        document.addEventListener("DOMContentLoaded", function () {
            // 发送 log 消息到 C++ 代码
            if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.log) {
                window.webkit.messageHandlers.log.postMessage("这是一个日志消息");
            } else {
                console.error("无法找到 log 消息处理程序");
            }
        });
    </script>
</head>

<body>
    <h1>Log Example</h1>
    <p>检查控制台以查看日志消息。</p>
    <button onclick="console.log('这是一个日志消息')">点击发送日志消息</button>
    <button onclick="console.log('这是一个错误消息')">点击发送错误消息</button>
    <h1>Calculator</h1>
    <button onclick="count()" id="counter">计数</button>
    <p id="result">0</p>
    
    <script>
        function count () {
            const counter = parseInt(document.getElementById('result').innerText) || 0;
            console.log('counter:', counter);
            const message = {
                arg1:   counter,
                arg2: 1
            };

            new Promise((resolve, reject) => {
                window.webkit.messageHandlers.addFunction.postMessage(message);
                window.addEventListener('message', function handler(event) {
                    if (event.data.type === 'resolve') {
                        resolve(event.data.result);
                    } else if (event.data.type === 'reject') {
                        reject(event.data.error);
                    }
                    window.removeEventListener('message', handler);
                });
            }).then(result => {
                document.getElementById('result').innerText = result;
            }).catch(error => {
                document.getElementById('result').innerText = error;
            });
        }
    </script>
    <script>
        // 拦截 console.log 方法 Proxy
        console.log = new Proxy(console.log, {
            apply: function (target, thisArg, argumentsList) {
                // 发送 log 消息到 C++ 代码
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.log) {
                    window.webkit.messageHandlers.log.postMessage(argumentsList.join(" "));
                } else {
                    console.error("无法找到 log 消息处理程序");
                }
                // 调用原始 console.log 方法
                return target.apply(thisArg, argumentsList);
            }
        });
        
    </script>
</body>

</html>